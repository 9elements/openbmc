From d02ad49eb60dd0761686220812b5afabb862693e Mon Sep 17 00:00:00 2001
From: Patrick Williams <patrick@stwcx.xyz>
Date: Mon, 8 May 2023 09:15:21 -0500
Subject: [PATCH 2/7] clang-tidy: reduce repo-specific flags

Adjust the clang-tidy settings so that it does not need to have
a bunch of values related to the libpeci subproject.  In general
we should be ignoring any header files from any subprojects since
they are not under direct control of the repository-under-test.

Change-Id: I64d4e4bae20ca27aed68081b4270fa0ec8fc0543
Signed-off-by: Patrick Williams <patrick@stwcx.xyz>
---
 .clang-tidy                | 3 ---
 include/linux/peci-ioctl.h | 3 +++
 src/IpmbSensor.hpp         | 2 +-
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/.clang-tidy b/.clang-tidy
index b2299bf..65f2c6c 100644
--- a/.clang-tidy
+++ b/.clang-tidy
@@ -306,6 +306,3 @@ CheckOptions:
   - { key: readability-identifier-naming.ParameterCase, value: camelBack }
   - { key: readability-identifier-naming.NamespaceCase, value: lower_case }
   - { key: readability-identifier-naming.StructCase,    value: CamelCase  }
-  - { key: readability-identifier-naming.StructIgnoredRegexp,    value: ((peci_xfer_msg)|(peci_ping_msg)|(peci_get_dib_msg)|(peci_get_temp_msg)|(peci_rd_pkg_cfg_msg)|(peci_wr_pkg_cfg_msg)|(peci_rd_ia_msr_msg)|(peci_wr_ia_msr_msg)|(peci_rd_ia_msrex_msg)|(peci_rd_pci_cfg_msg)|(peci_wr_pci_cfg_msg)|(peci_rd_pci_cfg_local_msg)|(peci_wr_pci_cfg_local_msg)|(peci_rd_end_pt_cfg_msg)|(peci_wr_end_pt_cfg_msg)|(peci_crashdump_disc_msg)|(peci_crashdump_get_frame_msg))  }
-  - { key: bugprone-reserved-identifier.AllowedIdentifiers,    value: __PECI_IOCTL_H }
-  - { key: cppcoreguidelines-macro-usage.AllowedRegexp,    value: ((__PECI_IOCTL_H)|(PECI_BASE_ADDR)|(PECI_OFFSET_MAX)|(PECI_BUFFER_SIZE)|(PECI_DEV_CC_SUCCESS)|(PECI_DEV_CC_NEED_RETRY)|(PECI_DEV_CC_OUT_OF_RESOURCE)|(PECI_DEV_CC_UNAVAIL_RESOURCE)|(PECI_DEV_CC_INVALID_REQ)|(PECI_DEV_CC_MCA_ERROR)|(PECI_DEV_CC_CATASTROPHIC_MCA_ERROR)|(PECI_DEV_CC_FATAL_MCA_DETECTED)|(PECI_DEV_CC_PARITY_ERROR_ON_GPSB_OR_PMSB)|(PECI_DEV_CC_PARITY_ERROR_ON_GPSB_OR_PMSB_IERR)|(PECI_DEV_CC_PARITY_ERROR_ON_GPSB_OR_PMSB_MCA)|(PECI_DEV_CC_RETRY_CHECK_MASK)|(PECI_DEV_RETRY_INTERVAL_MIN_MSEC)|(PECI_DEV_RETRY_INTERVAL_MAX_MSEC)|(PECI_DEV_RETRY_BIT)|(PECI_GET_DIB_WR_LEN)|(PECI_GET_DIB_RD_LEN)|(PECI_GET_DIB_CMD)|(PECI_GET_TEMP_WR_LEN)|(PECI_GET_TEMP_RD_LEN)|(PECI_GET_TEMP_CMD)|(PECI_RDPKGCFG_WRITE_LEN)|(PECI_RDPKGCFG_READ_LEN_BASE)|(PECI_RDPKGCFG_CMD)|(PECI_MBX_INDEX_CPU_ID)|(PECI_MBX_INDEX_VR_DEBUG)|(PECI_MBX_INDEX_PKG_TEMP_READ)|(PECI_MBX_INDEX_ENERGY_COUNTER)|(PECI_MBX_INDEX_ENERGY_STATUS)|(PECI_MBX_INDEX_WAKE_MODE_BIT)|(PECI_MBX_INDEX_EPI)|(PECI_MBX_INDEX_PKG_RAPL_PERF)|(PECI_MBX_INDEX_PER_CORE_DTS_TEMP)|(PECI_MBX_INDEX_DTS_MARGIN)|(PECI_MBX_INDEX_SKT_PWR_THRTL_DUR)|(PECI_MBX_INDEX_CFG_TDP_CONTROL)|(PECI_MBX_INDEX_CFG_TDP_LEVELS)|(PECI_MBX_INDEX_DDR_DIMM_TEMP)|(PECI_MBX_INDEX_CFG_ICCMAX)|(PECI_MBX_INDEX_TEMP_TARGET)|(PECI_MBX_INDEX_CURR_CFG_LIMIT)|(PECI_MBX_INDEX_DIMM_TEMP_READ)|(PECI_MBX_INDEX_DRAM_IMC_TMP_READ)|(PECI_MBX_INDEX_DDR_CH_THERM_STAT)|(PECI_MBX_INDEX_PKG_POWER_LIMIT1)|(PECI_MBX_INDEX_PKG_POWER_LIMIT2)|(PECI_MBX_INDEX_TDP)|(PECI_MBX_INDEX_TDP_HIGH)|(PECI_MBX_INDEX_TDP_UNITS)|(PECI_MBX_INDEX_RUN_TIME)|(PECI_MBX_INDEX_CONSTRAINED_TIME)|(PECI_MBX_INDEX_TURBO_RATIO)|(PECI_MBX_INDEX_DDR_RAPL_PL1)|(PECI_MBX_INDEX_DDR_PWR_INFO_HIGH)|(PECI_MBX_INDEX_DDR_PWR_INFO_LOW)|(PECI_MBX_INDEX_DDR_RAPL_PL2)|(PECI_MBX_INDEX_DDR_RAPL_STATUS)|(PECI_MBX_INDEX_DDR_HOT_ABSOLUTE)|(PECI_MBX_INDEX_DDR_HOT_RELATIVE)|(PECI_MBX_INDEX_DDR_THROTTLE_TIME)|(PECI_MBX_INDEX_DDR_THERM_STATUS)|(PECI_MBX_INDEX_TIME_AVG_TEMP)|(PECI_MBX_INDEX_TURBO_RATIO_LIMIT)|(PECI_MBX_INDEX_HWP_AUTO_OOB)|(PECI_MBX_INDEX_DDR_WARM_BUDGET)|(PECI_MBX_INDEX_DDR_HOT_BUDGET)|(PECI_MBX_INDEX_PKG_PSYS_PWR_LIM3)|(PECI_MBX_INDEX_PKG_PSYS_PWR_LIM1)|(PECI_MBX_INDEX_PKG_PSYS_PWR_LIM2)|(PECI_MBX_INDEX_PKG_PSYS_PWR_LIM4)|(PECI_MBX_INDEX_PERF_LIMIT_REASON)|(PECI_PKG_ID_CPU_ID)|(PECI_PKG_ID_PLATFORM_ID)|(PECI_PKG_ID_UNCORE_ID)|(PECI_PKG_ID_MAX_THREAD_ID)|(PECI_PKG_ID_MICROCODE_REV)|(PECI_PKG_ID_MACHINE_CHECK_STATUS)|(PECI_WRPKGCFG_WRITE_LEN_BASE)|(PECI_WRPKGCFG_READ_LEN)|(PECI_WRPKGCFG_CMD)|(PECI_MBX_INDEX_DIMM_AMBIENT)|(PECI_MBX_INDEX_DIMM_TEMP)|(PECI_RDIAMSR_WRITE_LEN)|(PECI_RDIAMSR_READ_LEN)|(PECI_RDIAMSR_CMD)|(PECI_WRIAMSR_CMD)|(PECI_RDIAMSREX_WRITE_LEN)|(PECI_RDIAMSREX_READ_LEN)|(PECI_RDIAMSREX_CMD)|(PECI_RDPCICFG_WRITE_LEN)|(PECI_RDPCICFG_READ_LEN)|(PECI_RDPCICFG_READ_LEN_MAX)|(PECI_RDPCICFG_CMD)|(PECI_PCI_BUS0_CPU0)|(PECI_PCI_BUS0_CPU1)|(PECI_PCI_CPUBUSNO_BUS)|(PECI_PCI_CPUBUSNO_DEV)|(PECI_PCI_CPUBUSNO_FUNC)|(PECI_PCI_CPUBUSNO)|(PECI_PCI_CPUBUSNO_1)|(PECI_PCI_CPUBUSNO_VALID)|(PECI_WRPCICFG_CMD)|(PECI_RDPCICFGLOCAL_WRITE_LEN)|(PECI_RDPCICFGLOCAL_READ_LEN_BASE)|(PECI_RDPCICFGLOCAL_CMD)|(PECI_WRPCICFGLOCAL_WRITE_LEN_BASE)|(PECI_WRPCICFGLOCAL_READ_LEN)|(PECI_WRPCICFGLOCAL_CMD)|(PECI_RDENDPTCFG_PCI_WRITE_LEN)|(PECI_RDENDPTCFG_MMIO_D_WRITE_LEN)|(PECI_RDENDPTCFG_MMIO_Q_WRITE_LEN)|(PECI_RDENDPTCFG_READ_LEN_BASE)|(PECI_RDENDPTCFG_CMD)|(PECI_ENDPTCFG_TYPE_LOCAL_PCI)|(PECI_ENDPTCFG_TYPE_PCI)|(PECI_ENDPTCFG_TYPE_MMIO)|(PECI_ENDPTCFG_ADDR_TYPE_PCI)|(PECI_ENDPTCFG_ADDR_TYPE_MMIO_D)|(PECI_ENDPTCFG_ADDR_TYPE_MMIO_Q)|(PECI_WRENDPTCFG_PCI_WRITE_LEN_BASE)|(PECI_WRENDPTCFG_MMIO_D_WRITE_LEN_BASE)|(PECI_WRENDPTCFG_MMIO_Q_WRITE_LEN_BASE)|(PECI_WRENDPTCFG_READ_LEN)|(PECI_WRENDPTCFG_CMD)|(PECI_CRASHDUMP_CORE)|(PECI_CRASHDUMP_TOR)|(PECI_CRASHDUMP_PAYLOAD_SIZE)|(PECI_CRASHDUMP_AGENT_ID)|(PECI_CRASHDUMP_AGENT_PARAM)|(PECI_CRASHDUMP_ENABLED)|(PECI_CRASHDUMP_NUM_AGENTS)|(PECI_CRASHDUMP_AGENT_DATA)|(PECI_CRASHDUMP_DISC_WRITE_LEN)|(PECI_CRASHDUMP_DISC_READ_LEN_BASE)|(PECI_CRASHDUMP_DISC_VERSION)|(PECI_CRASHDUMP_DISC_OPCODE)|(PECI_CRASHDUMP_GET_FRAME_WRITE_LEN)|(PECI_CRASHDUMP_GET_FRAME_READ_LEN_BASE)|(PECI_CRASHDUMP_GET_FRAME_VERSION)|(PECI_CRASHDUMP_GET_FRAME_OPCODE)|(PECI_CRASHDUMP_CMD)|PECI_IOC_BASE) }
diff --git a/include/linux/peci-ioctl.h b/include/linux/peci-ioctl.h
index 42a9979..f94c621 100644
--- a/include/linux/peci-ioctl.h
+++ b/include/linux/peci-ioctl.h
@@ -2,6 +2,7 @@
 /* Copyright (c) 2018-2019 Intel Corporation */
 
 // clang-format off
+// NOLINTBEGIN
 
 #ifndef __PECI_IOCTL_H
 #define __PECI_IOCTL_H
@@ -669,4 +670,6 @@ struct peci_crashdump_get_frame_msg {
 #endif
 
 #endif /* __PECI_IOCTL_H */
+
+// NOLINTEND
 // clang-format on
diff --git a/src/IpmbSensor.hpp b/src/IpmbSensor.hpp
index bf94509..54a2a4a 100644
--- a/src/IpmbSensor.hpp
+++ b/src/IpmbSensor.hpp
@@ -46,7 +46,7 @@ namespace sensor
 constexpr uint8_t netFn = 0x04;
 constexpr uint8_t getSensorReading = 0x2d;
 
-static bool isValid(const std::vector<uint8_t>& data)
+static inline bool isValid(const std::vector<uint8_t>& data)
 {
     constexpr auto readingUnavailableBit = 5;
 
-- 
2.39.2

